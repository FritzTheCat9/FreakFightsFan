@inherits InputBase<int?>
@inject IMyDictionaryItemApiClient MyDictionaryItemApiClient
@inject IExceptionHandler ExceptionHandler

<FluentAutocomplete SelectedOptions="DictionaryItems" Label="@Label" Placeholder="@Placeholder" style="width: 100%;"
                    TOption="MyDictionaryItemDto" OnOptionsSearch="SearchMyDictionaryItems" SelectedOptionsChanged="SelectedOptionsChanged"
                    OptionText="(item => item.Name)" MaximumSelectedOptions="1" AutoComplete="@Autocomplete">
    <SelectedOptionTemplate Context="item">
        <FluentLabel>
            @item.Name
        </FluentLabel>
    </SelectedOptionTemplate>
    <FooterContent Context="item">
        @if (!item.Any())
        {
            <FluentLabel Style="font-size: 11px; text-align: center; width: 200px;">
                No items found in dictionary with code: "@DictionaryCode"
            </FluentLabel>
        }
    </FooterContent>
</FluentAutocomplete>

@code {
    [Parameter] public string Label { get; set; }
    [Parameter] public string Placeholder { get; set; }
    [Parameter] public string DictionaryCode { get; set; }
    [Parameter] public MyDictionaryItemDto DictionaryItem { get; set; }
    [Parameter] public string Autocomplete { get; set; } = "off";

    private IEnumerable<MyDictionaryItemDto> DictionaryItems { get; set; } = [];

    protected override async Task OnInitializedAsync()
    {
        if (DictionaryItem is not null)
        {
            DictionaryItems = new List<MyDictionaryItemDto>() { DictionaryItem };

            Value = DictionaryItems.FirstOrDefault()?.Id;
            await ValueChanged.InvokeAsync(Value);

            EditContext.NotifyFieldChanged(FieldIdentifier);
        }
    }

    protected override bool TryParseValueFromString(string value, out int? result, out string validationErrorMessage)
    {
        result = DictionaryItems.FirstOrDefault()?.Id;
        validationErrorMessage = null;
        return true;
    }

    public async void SelectedOptionsChanged(IEnumerable<MyDictionaryItemDto> dictionaryItems)
    {
        DictionaryItems = dictionaryItems;

        Value = DictionaryItems.FirstOrDefault()?.Id;
        await ValueChanged.InvokeAsync(Value);

        EditContext.NotifyFieldChanged(FieldIdentifier);
    }

    public async Task SearchMyDictionaryItems(OptionsSearchEventArgs<MyDictionaryItemDto> e)
    {
        e.Items = await ReturnMyDictionaryItems(e.Text, DictionaryCode);
    }

    public async Task<List<MyDictionaryItemDto>> ReturnMyDictionaryItems(string searchText, string dictionaryCode)
    {
        PagedList<MyDictionaryItemDto> DictionaryItemsPagedList;

        var query = new GetAllMyDictionaryItemsByCode.Query
        {
            Page = 1,
            PageSize = 10,
            SortColumn = "name",
            SortOrder = SortOrder.Ascending,
            SearchTerm = searchText ?? "",
            DictionaryCode = dictionaryCode,
        };

        try
        {
            DictionaryItemsPagedList = await MyDictionaryItemApiClient.GetAllMyDictionaryItemsByCode(query);
            return DictionaryItemsPagedList.Items;
        }
        catch (Exception ex)
        {
            ExceptionHandler.HandleExceptions(ex);
            return new List<MyDictionaryItemDto>();
        }
    }
}